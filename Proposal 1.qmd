---
title: "Proposal 1"
format: pdf
author: "Names"
editor: visual
---

Proposal One

First proposal of the project

Graph Presentation

```{r, include = FALSE} 
library(tidyverse) library(nflfastR) library(ggimage) library(gt) library(ggthemes) library(ggrepel) library(plotly) library(vip)

long_pbp <- load_pbp(1999:2024)

long_pbp %\>% group_by(season) %\>% summarise(n = n())

long_pbp %\>% group_by(play_type) %\>% summarise(n = n())

qbs <- long_pbp %\>% filter(season_type == "REG", !is.na(epa)) %\>% group_by(id, name) %\>% dplyr::summarise( epa = mean(qb_epa), cpoe = mean(cpoe, na.rm = T), n_dropbacks = sum(pass), n_plays = n(), team = last(posteam) ) %\>% ungroup() %\>% filter(n_dropbacks \> 10 & n_plays \> 100)

qbs <- qbs %\>% left_join(teams_colors_logos, by = c('team' = 'team_abbr'))

offense <- long_pbp %\>% group_by(posteam) %\>% summarise(off_epa = mean(epa, na.rm = TRUE))

defense <- long_pbp %\>% group_by(defteam) %\>% summarise(def_epa = mean(epa, na.rm = TRUE))

logos <- teams_colors_logos %\>% dplyr::select(team_abbr, team_logo_espn)
```

```{r, echo = FALSE} 
\# Sample offense and defense data (replace with your actual data) offense \<- offense %\>% filter(!is.na(posteam) & posteam != "") defense \<- defense %\>% filter(!is.na(defteam) & defteam != "") off_epa \<- offense$off_epa def_epa <- defense$def_epa team_names \<- offense\$posteam \# Assuming this column contains team abbreviations

# Set up the plotting area (this initializes the plot)

plot(off_epa, def_epa, xlab = "Offense EPA/play", ylab = "Defense EPA/play", main = "NFL Offensive and Defensive EPA per Play 1999-2024", pch = 16, \# Use solid circle to plot points col = "blue", \# Color of points asp = 16/9, \# Set aspect ratio xlim = range(off_epa, na.rm = TRUE), ylim = range(def_epa, na.rm = TRUE) )

# Now add diagonal lines (after plot is initialized)

slopes \<- c(.4, .3, .2, .1, 0, -.1, -.2, -.3) for (i in seq_along(slopes)) { abline(a = slopes\[i\], b = -1.5, col = "gray", lty = "dotted", lwd = 0.5) }

# Add horizontal and vertical reference lines (after plot is initialized)

abline(h = mean(off_epa, na.rm = TRUE), col = "red", lty = "dashed") abline(v = mean(def_epa, na.rm = TRUE), col = "red", lty = "dashed")

# Label the points with team names

text(off_epa, def_epa, labels = team_names, pos = 4, cex = 0.8, col = "black")
```

```{r, echo = FALSE} 
\## Filtering Data for future plots first_pbp \<- load_pbp(1999:2010) second_pbp \<- load_pbp(2011:2024)

# Getting just 4th downs

fourth_downs_first <- first_pbp \|\> filter(down == 4, !is.na(play_type))

fourth_downs_first <- fourth_downs_first %\>% filter(!is.na(yardline_100) & !is.na(ydstogo) & !is.na(wp))

# See what usually happens on 4th down

fourth_downs_first \|\> group_by(play_type) \|\> tally(sort = T) \|\> print(n = 10)

# Creating an indicator variable

fourth_downs_first <- fourth_downs_first \|\> mutate(went_for_it = ifelse(play_type %in% c("pass", "run"), 1, 0))
```
Yards to go bar plot

```{r, echo = FALSE} 
ydstogo_summary <- fourth_downs_first %\>% group_by(ydstogo) %\>% summarize(count = n(), went_for_it_rate = mean(went_for_it)) %\>% filter(count \>= 5)

barplot(ydstogo_summary$went_for_it_rate, names.arg = ydstogo_summary$ydstogo, col = heat.colors(length(ydstogo_summary\$went_for_it_rate)), \# Color fill xlab = "Yards to Go", ylab = "Went For It Rate", main = "Went For It Rate by Yards to Go", border = "white")
```

4th down by yardline

```{r, echo = FALSE} 
yardline_summary \<- fourth_downs_first %\>% group_by(yardline_100) %\>% summarize(count = n(), went_for_it_rate = mean(went_for_it)) %\>% filter(count \>= 5)

# Create the barplot

barplot(yardline_summary$went_for_it_rate, names.arg = yardline_summary$yardline_100, col = heat.colors(length(yardline_summary\$went_for_it_rate)), \# Color fill xlab = "Yardline", ylab = "Went For It Rate", main = "Went For It Rate by Yardline", border = "white")
```

Win Probability
```{r, echo = FALSE} 
\# Summarize the data wp_summary \<- fourth_downs_first %\>% mutate(wp_rounded = round(wp, 2)) %\>% group_by(wp_rounded) %\>% summarize(count = n(), went_for_it_rate = mean(went_for_it))

# Create the barplot

barplot(wp_summary$went_for_it_rate, names.arg = wp_summary$wp_rounded, col = heat.colors(length(wp_summary\$went_for_it_rate)), \# Color fill xlab = "Win Probability (Rounded)", ylab = "Went For It Rate", main = "Went For It Rate by Win Probability", border = "white")
```

Logistic Regression - Fourth Down Modeling
``` {r, echo = FALSE} 
log_fourth \<- glm(went_for_it \~ yardline_100 + ydstogo + wp, data = fourth_downs_first)

# Getting the summary

summary(log_fourth)

# Getting the variable importance

vip(log_fourth)

# Accounting for interaction effects

log_fourth_co \<- glm(went_for_it \~ (yardline_100 + ydstogo + wp)\^2, data = fourth_downs_first)

summary(log_fourth_co)
```

Predicted Probability of going for it vs yards to go
```{r, include = FALSE} 
fourth_downs_first$pred_prob <- log_fourth$fitted.values

# Create the initial plot (line plot of pred_prob vs. ydstogo)

plot(fourth_downs_first$ydstogo, fourth_downs_first$pred_prob, type = "l", \# Line plot col = "black", lwd = 2, \# Line thickness xlab = "Yards to Go", ylab = "Chance Offense Will Go For It (0-1)", main = "Predicted Probability of Going for It vs. Yards to Go")

# Overlay points: different colors for went_for_it == 1 and 0

points(fourth_downs_first$ydstogo[fourth_downs_first$went_for_it == 1\], fourth_downs_first$went_for_it[fourth_downs_first$went_for_it == 1\], col = "darkgreen", pch = 19, cex = 0.7 \# Point size )

points(fourth_downs_first$ydstogo[fourth_downs_first$went_for_it == 0\], fourth_downs_first$went_for_it[fourth_downs_first$went_for_it == 0\], col = "darkred", pch = 19, cex = 0.7)

# Optional: Add a legend to indicate the color coding

legend("topright", legend = c("Went for it", "Did not go for it"), col = c("darkgreen", "darkred"), pch = 19, bty = "n")
```

^fix this graph lool
```{r, include = FALSE} 
\## 4th down Modeling fourth_downs_first \<- fourth_downs_first \|\> mutate(pred_prob = log_fourth\$fitted.values) \|\> mutate(fourth_oe = went_for_it - pred_prob)

team_fourth_first \<- fourth_downs_first \|\> filter(season \>= 1999 & season \<= 2010) \|\> group_by(posteam) \|\> summarize(count = n(), exp_fourths = sum(pred_prob), actual_fourths = sum(went_for_it), fourths_oe = sum(fourth_oe)) \|\> left_join(teams_colors_logos, by = c("posteam" = "team_abbr"))

# Getting fourth down go's over expected

fourth_downs_first \<- fourth_downs_first \|\> mutate(pred_prob = log_fourth\$fitted.values) \|\> mutate(fourth_oe = went_for_it - pred_prob)

team_fourth_first \<- fourth_downs_first \|\> filter(season \>= 1999 & season \<= 2010) \|\> group_by(posteam) \|\> summarize(count = n(), exp_fourths = sum(pred_prob), actual_fourths = sum(went_for_it), fourths_oe = sum(fourth_oe)) \|\> left_join(teams_colors_logos, by = c("posteam" = "team_abbr"))

team_fourth_long \<- team_fourth_first \|\> select(posteam, actual_fourths, exp_fourths, team_logo_espn) \|\> pivot_longer(cols = c(actual_fourths, exp_fourths), names_to = "type", values_to = "value")
```

4th down actual vs expected

```{r, echo = FALSE} 
ggplot(team_fourth_long, aes(x = posteam, y = value, color = type)) + geom_point(position = position_jitter(width = 0.2), size = 4) + geom_image(aes(image = team_logo_espn), position = position_jitter(width = 0.2), size = 0.05, asp = 16/9) + theme_minimal() + labs(x = "Teams", y = "Number of 4th Downs", title = "Team 4th Down Actual vs Expected Go's", subtitle = "1999-2010") + scale_color_manual(values = c("actual_fourths" = "skyblue", "exp_fourths" = "lightgreen"), name = "Type", labels = c("Actual 4th Downs", "Expected 4th Downs")) + theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "top")
```
\^ make this not ggplot


**Boxplot**
```{r pressure, echo=FALSE}
run_plays_with_gap = long_pbp[!is.na(long_pbp$run_gap) |!is.na(long_pbp$run_location), ]
# Ensure data is numeric and factors are correctly set
run_plays_with_gap$yards_gained <- as.numeric(run_plays_with_gap$yards_gained)
run_plays_with_gap$run_gap <- as.factor(run_plays_with_gap$run_gap)
run_plays_with_gap$run_location <- as.factor(run_plays_with_gap$run_location)

# Create run_gap_location if not already done
run_plays_with_gap$run_gap_location <- interaction(run_plays_with_gap$run_gap, run_plays_with_gap$run_location)

# Calculate counts for each group
counts <- table(run_plays_with_gap$run_gap_location)

# Set minimum number of data points required
min_count <- 100

# Filter the data to include only groups with enough data points
filtered_data <- run_plays_with_gap[run_plays_with_gap$run_gap_location %in% names(counts[counts >= min_count]), ]
filtered_data$run_gap_location <- droplevels(filtered_data$run_gap_location)
# Create the boxplot with filtered data
boxplot(filtered_data$yards_gained ~ filtered_data$run_gap_location,
                       main = 'Yards gained on each run play',
                       xlab = 'Run gap and location', ylab = 'Yards gained',
                       outline = FALSE, las = 2, cex.axis = 0.7)  # Adjust cex.axis to control x-axis label size

# Get the counts for filtered data
filtered_counts <- table(filtered_data$run_gap_location)

# Rotate labels and move xlabel further away
par(mar = c(7, 4, 4, 2) + 0.1)

#boxplot_obj
```
There is not a huge statistically significant difference in the effeciencies of run plays in different gaps. While inside runs to the tackle and guard are generally safer (small potential for a big loss), they also have a lower potential for a big gain. On the other hand, run plays to the outside have a much larger potential for gain but also a larger potential for a big loss. There's also no notable difference between running to the left and right. 


```{r}
#install.packages("nflreadr")
library(nflreadr)
library(dplyr)
data <- load_schedules(seasons = 1999:2023) |>                                              
  filter(game_type == "REG")

data$home_team <- paste0(data$home_team, " ", data$season)
data$away_team <- paste0(data$away_team, " ", data$season)

team_matrix_home <- model.matrix(~ home_team, data = data)
team_matrix_away <- model.matrix(~ away_team, data = data)
team_matrix <- team_matrix_home - team_matrix_away  

team_data <- as.data.frame(team_matrix[, -1])
names(team_data) <- sort(unique(data$home_team))[-1]

linear_model <- lm(data$result ~ ., data = team_data)
#summary(linear_model)    

team_strength <- data.frame(
  team = names(coef(linear_model))[-1],
  strength = coef(linear_model)[-1]
)

logistic_model <- glm(data$result > 0 ~ ., data = team_data, family = binomial())
#summary(logistic_model)

team_strength_2 <- data.frame(
  team = names(coef(logistic_model))[-1],
  strength = coef(logistic_model)[-1]
)

# Step 1: Extract the top 15 teams from both ordered dataframes
top_15_model_1 <- team_strength_ordered %>% top_n(15, strength)
top_15_model_2 <- team_strength_ordered_2 %>% top_n(15, strength)

# Step 2: Combine these teams into one dataframe
combined_teams <- full_join(top_15_model_1, top_15_model_2, by = "team", suffix = c("_model_1", "_model_2"))

# Step 3: Fill NA values with 0 or any appropriate value
combined_teams <- combined_teams %>%
  mutate(
    strength_model_1 = ifelse(is.na(strength_model_1), 0, strength_model_1),
    strength_model_2 = ifelse(is.na(strength_model_2), 0, strength_model_2)
  )

#combined_teams

n <- nrow(combined_teams)
strength_diff_model_1 <- outer(combined_teams$strength_model_1, combined_teams$strength_model_1, "-")
strength_diff_model_2 <- outer(combined_teams$strength_model_2, combined_teams$strength_model_2, "-")

create_heatmap_with_legend <- function(matrix, title) {
  filled.contour(
    x = 1:n, y = 1:n, z = t(matrix)[, n:1],
    color.palette = heat.colors,
    plot.title = title(main = title),
    plot.axes = {
      axis(1, at = 1:n, labels = combined_teams$team_season, las = 2, cex.axis = 0.7)
      axis(2, at = 1:n, labels = rev(combined_teams$team_season), las = 2, cex.axis = 0.7)
    },
    xlab = "Teams", ylab = "Teams"
  )
}

# Plot heatmaps
par(mfrow = c(1, 2))  # Plot side by side
create_heatmap(strength_diff_model_1, "Strength Difference Using Metric 1")
create_heatmap(strength_diff_model_2, "Strength Difference Using Metric 2")
```
Interpretation: We created two different metrics to assess the strengths of teams in the years 1999 to 2023, and we took the 15 strongest teams using each metric. Then, combining those lists we got a total of 23 teams, and calculated the difference in strengths between every combination of those teams using each metric. We found that in general metric 1 gives more consistent results with regards to the head to head results. 